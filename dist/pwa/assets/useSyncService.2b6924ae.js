import{ab as K,r as d,o as S,b0 as r,b1 as _}from"./index.6100804f.js";import{u as x}from"./use-quasar.087a6977.js";import{u as b}from"./useOnlineStatus.7641e145.js";function $(){const k=K(),l=x(),s=d(null),i=d(null),t=d({kegiatan:[],assignmentData:[]}),p=b();S(async()=>{});const u=async(a,e)=>{await r.setItem(`${"syncData.kegiatan."+e}`,JSON.stringify(a)),t.value.kegiatan[e]=a},o=async a=>{let e=g(a);if(!Boolean(e)){let n=await r.getItem(`${"syncData.kegiatan."+a}`);t.value.kegiatan.push(JSON.parse(n)),e=g(a)}return e},g=a=>t.value.kegiatan.find(e=>e.kegiatan.id===a),c=a=>t.value.assignmentData.find(e=>(e==null?void 0:e.id)===a),f=async a=>{if(p.isOnline)await _.get(`/kegiatans/${a}`).then(async e=>{await u(e.data,a)});else throw new Error("Anda sedang offline. Tidak dapat melakukan sinkronisasi")},D=async a=>{console.log("newAssignment",a),await h(),await o(a.kegiatan_id);let e=c(a.id);return Boolean(e==null?void 0:e.id)?e.responden.terakhir_diisi<a.responden.terakhir_diisi?(await m(a),console.log("replace Assignment"),!0):(console.log("replace assignment failed"),!1):(console.log("pushing assignment"),await v(a),!0)},m=async a=>{let e=t.value.assignmentData.findIndex(n=>n.id===a.id);e!==-1&&(t.value.assignmentData[e]=a,await y()),e=t.value.kegiatan[a.kegiatan_id].assignments.findIndex(n=>n.id===a.id),e!==-1&&(t.value.kegiatan[a.kegiatan_id].assignments[e]=a)},v=async a=>{console.log("kegiatanData",i);let e=t.value.kegiatan.findIndex(n=>(console.log("obj",n),n.kegiatan.id==a.kegiatan_id));t.value.kegiatan[e].assignments.push(a),await u(t.value.kegiatan[e],a.kegiatan_id),await y()},y=async()=>{await r.setItem("syncData.assignmentData",JSON.stringify(t.value.assignmentData))},h=async()=>(Boolean(t.value.assignmentData.length)||(t.value.assignmentData=JSON.parse(await r.getItem("syncData.assignmentData")),await w()),t.value.assignmentData),w=async()=>{t.value.assignmentData.forEach(async a=>{let e=c(a.id);return Boolean(e)?e.responden.terakhir_diisi<a.responden.terakhir_diisi?(await m(a),!0):!1:(await v(a),!0)})};return{getDataKegiatan:o,setDataKegiatan:u,findKegiatan:g,findAssignmentKegiatan:c,syncKegiatan:f,handleLoadKegiatan:async()=>{s.value=await k.getSelectedKegiatan();let a=null,e=null;try{e=l.notify({progress:!0,message:"Mengambil data",spinner:!0,color:"blue",textColor:"white",timeout:2e3}),i.value=await o(s.value.id),Boolean(i.value)||(a=l.notify({progress:!0,message:"Sync",spinner:!0,color:"blue",textColor:"white",timeout:2e3}),await f(s.value.id),i.value=await o(s.value.id),a()),e()}catch(n){e(),l.notify({progress:!0,type:"negative",message:n.message,timeout:2e3})}return i.value},addAssignment:D}}export{$ as u};
